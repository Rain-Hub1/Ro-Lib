<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat ID Dinâmico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
    <script>
        const Fundo = '#161717';
        const TextboxBg = '#2E2E2F';
        const TextoNormal = '#BDBDBD';
        const BotaoBg = '#FFFFFF';
        const BotaoTexto = '#181918';
        const AI_SENDER_ID = 'ai-assistant'; 

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fundo': Fundo,
                        'textbox-bg': TextboxBg,
                        'texto-normal': TextoNormal,
                        'botao-bg': BotaoBg,
                        'botao-texto': BotaoTexto,
                        'accent-blue': '#3b82f6', 
                        'card-bg': '#242526',
                        'ai-bg': '#581c87',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }

        const PARSE_APP_ID = window.__APP_ID || 'UVMWj4jbFXFBkSemQKRyT9UXGfLBz7HnAlr53lV8';
        const PARSE_JS_KEY = window.__JS_KEY || 'K35x8pgg6Zlw8hHgi4lNiRFkjHpiBO1gJYI2VcPF';
        const GEMINI_API_KEY = window.__GEMINI_API_KEY || 'AIzaSyB7ou_FpcqAcb21dv5BKoXZl_ve2NHhA3I';
        const PARSE_SERVER_URL = 'https://parseapi.back4app.com/';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        Parse.initialize(PARSE_APP_ID, PARSE_JS_KEY);
        Parse.serverURL = PARSE_SERVER_URL;
        
        const Chat = Parse.Object.extend("Chat");
        const Message = Parse.Object.extend("Message");
        
        let userId = null;
        let currentChatId = null;
        let currentChatObjectId = null;
        let subscription = null;
        let isAITyping = false;

        const urlParams = new URLSearchParams(window.location.search);
        currentChatId = urlParams.get('id');

        const displayError = (message) => {
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('loadingStatus').classList.add('hidden');
            document.getElementById('errorContainer').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        };
        
        const checkAuth = () => {
            const currentUser = Parse.User.current();
            if (!currentUser) {
                displayError("Você precisa estar logado para ver o chat.");
                setTimeout(() => window.location.href = 'Login.html', 3000);
                return null;
            }
            userId = currentUser.id;
            return currentUser;
        };

        const loadChatDetails = async (uid) => {
            if (PARSE_APP_ID.includes('YOUR_BACK4APP')) {
                displayError("ERRO: As chaves do Back4App não foram configuradas. Por favor, configure as variáveis de ambiente.");
                return;
            }
            if (!currentChatId) {
                displayError("ID do chat não fornecido na URL.");
                return;
            }

            try {
                const query = new Parse.Query(Chat);
                query.equalTo("chatId", currentChatId);
                const chat = await query.first();

                if (!chat) {
                    displayError(`Chat ID "${currentChatId}" não encontrado.`);
                    return;
                }

                currentChatObjectId = chat.id;

                if (chat.get('ownerId') !== uid) {
                    displayError("Acesso negado. Você não é o dono deste chat.");
                    return;
                }

                document.getElementById('chatNameDisplay').textContent = chat.get('chatName');
                document.getElementById('chatIdDisplay').textContent = `ID: ${currentChatId}`;

                setupLiveQuery();
                document.getElementById('loadingStatus').classList.add('hidden');
                document.getElementById('chatContainer').classList.remove('hidden');

            } catch (e) {
                console.error("Erro ao carregar detalhes do chat:", e);
                displayError(`Falha ao verificar as permissões do chat: ${e.message}`);
            }
        };

        const renderMessages = (messages) => {
            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';
            
            if (messages.length === 0 && !isAITyping) {
                messagesList.innerHTML = `<p class="text-center text-gray-500 p-4">Comece a conversa! Envie a primeira mensagem.</p>`;
                return;
            }

            const finalMessages = messages.filter(msg => msg.get('text') !== 'AI está digitando...');
            
            finalMessages.forEach(msg => {
                const senderId = msg.get('senderId');
                const isUser = senderId === userId;
                const messageClass = isUser ? 'bg-accent-blue text-white self-end' : 'bg-ai-bg text-texto-normal self-start';
                
                const item = document.createElement('div');
                item.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${messageClass}`;
                
                let senderLabel = '';
                if (senderId === AI_SENDER_ID) {
                    senderLabel = `<span class="text-xs font-bold text-gray-300 block mb-1">Assistente AI</span>`;
                }
                
                item.innerHTML = `${senderLabel}<p>${msg.get('text')}</p>`;
                messagesList.appendChild(item);
            });

            if (isAITyping) {
                 const typingIndicator = document.createElement('div');
                 typingIndicator.id = 'typingIndicator';
                 typingIndicator.className = 'self-start max-w-fit p-3 rounded-xl shadow-md bg-ai-bg text-texto-normal animate-pulse';
                 typingIndicator.innerHTML = 'Assistente AI está digitando...';
                 messagesList.appendChild(typingIndicator);
            }

            messagesList.scrollTop = messagesList.scrollHeight; 
        };

        const setupLiveQuery = async () => {
            if (!currentChatObjectId) return;

            const messageQuery = new Parse.Query(Message);
            messageQuery.equalTo("chatPointer", Parse.Object.extend("Chat").createWithoutData(currentChatObjectId));
            messageQuery.ascending("createdAt");

            try {
                const client = new Parse.LiveQueryClient({
                    applicationId: PARSE_APP_ID,
                    serverURL: 'wss://' + PARSE_SERVER_URL.split('//')[1].replace('parseapi', 'livequery'), 
                    javascriptKey: PARSE_JS_KEY 
                });
                client.open();

                subscription = await client.subscribe(messageQuery);

                subscription.on('create', () => {
                    messageQuery.find().then(renderMessages);
                });
                
                messageQuery.find().then(renderMessages);

            } catch (e) {
                console.error("Erro ao configurar LiveQuery. Voltando ao carregamento manual.", e);
                messageQuery.find().then(renderMessages);
            }
        };

        const generateAIResponse = async (userText) => {
            if (!GEMINI_API_KEY) {
                console.error("Chave GEMINI_API_KEY não configurada.");
                return;
            }
            if (isAITyping) return;

            isAITyping = true;
            renderMessages([]);

            const payload = {
                contents: [{ parts: [{ text: `Responda a esta mensagem em Português (Brasil). Mantenha a resposta concisa e amigável: ${userText}` }] }],
                systemInstruction: { parts: [{ text: "Você é um assistente de chat amigável, prestativo e conciso. Responda em Português." }] },
            };
            let responseText = "Desculpe, não consegui obter uma resposta do AI (Erro de Conexão).";
            
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP status: ${response.status}`);

                    const result = await response.json();
                    responseText = result.candidates?.[0]?.content?.parts?.[0]?.text || responseText;
                    break; 

                } catch (error) {
                    console.error(`Tentativa ${attempt + 1}: Falha na chamada da API Gemini.`, error);
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }

            isAITyping = false;
            
            const aiMessage = new Message();
            aiMessage.set("text", responseText);
            aiMessage.set("senderId", AI_SENDER_ID);
            aiMessage.set("chatId", currentChatId);
            aiMessage.set("chatPointer", Parse.Object.extend("Chat").createWithoutData(currentChatObjectId));
            
            try {
                await aiMessage.save();
            } catch (e) {
                console.error("Erro ao salvar resposta do AI:", e);
                renderMessages([]); 
            }
        };

        const sendMessage = async (text) => {
            if (!userId || !currentChatObjectId || isAITyping) return;

            const message = new Message();
            
            try {
                message.set("text", text);
                message.set("senderId", userId);
                message.set("chatId", currentChatId);
                message.set("chatPointer", Parse.Object.extend("Chat").createWithoutData(currentChatObjectId));

                await message.save();
                
                await generateAIResponse(text);

            } catch (e) {
                console.error("Erro ao enviar mensagem:", e);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;

            loadChatDetails(userId);

            document.getElementById('messageForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (text) {
                    sendMessage(text);
                    input.value = ''; 
                }
            });
        });
    </script>
</head>
<body class="bg-fundo min-h-screen flex flex-col font-sans text-texto-normal">
    
    <header class="bg-card-bg shadow-lg shadow-gray-900 p-4 border-b border-gray-700 flex justify-between items-center">
        <div>
            <h1 id="chatNameDisplay" class="text-xl font-bold text-white">Carregando Chat...</h1>
            <p id="chatIdDisplay" class="text-sm text-gray-500">Aguarde a validação</p>
        </div>
        <a href="Home.html" class="py-2 px-4 bg-botao-bg text-botao-texto font-semibold rounded-lg shadow-md hover:bg-gray-200 transition duration-300">
            Voltar
        </a>
    </header>

    <div id="loadingStatus" class="flex-1 flex items-center justify-center p-8">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-accent-blue mx-auto mb-4"></div>
            <p class="text-gray-400">Verificando permissões e carregando chat...</p>
        </div>
    </div>

    <div id="errorContainer" class="hidden flex-1 flex items-center justify-center p-8">
        <div class="bg-red-900 text-red-300 p-6 rounded-xl shadow-xl border border-red-700 max-w-sm text-center">
            <p id="errorMessage" class="font-semibold text-lg">Erro de acesso.</p>
            <p class="mt-2 text-sm">Verifique se o ID do chat está correto e se você configurou as chaves de ambiente.</p>
        </div>
    </div>

    <main id="chatContainer" class="hidden flex-1 flex flex-col p-4 overflow-hidden">
        <div id="messagesList" class="flex-1 overflow-y-auto space-y-4 p-4 mb-4 flex flex-col">
        </div>
        
        <form id="messageForm" class="flex gap-2">
            <input type="text" id="messageInput" required placeholder="Digite sua mensagem..."
                   class="flex-1 px-4 py-2 border border-gray-600 bg-textbox-bg text-texto-normal rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue">
            <button type="submit" class="py-2 px-4 bg-accent-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                Enviar
            </button>
        </form>
    </main>
</body>
</html>
